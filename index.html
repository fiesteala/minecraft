import React, { useState, useRef, useEffect } from 'react';
import { MapPin, Calendar, Clock, CheckSquare, X, Volume2, VolumeX, Play, Gift } from 'lucide-react';

export default function App() {
  // ESTADOS
  const [hasStarted, setHasStarted] = useState(false);
  const [gameState, setGameState] = useState('start'); // start, mining, open
  const [blockHealth, setBlockHealth] = useState(5);
  const [particles, setParticles] = useState([]);
  
  // ESTADOS MODALES
  const [showRSVP, setShowRSVP] = useState(false);
  const [showGifts, setShowGifts] = useState(false); // Nuevo estado para regalos
  const [rsvpName, setRsvpName] = useState('');
  const [isSubmitted, setIsSubmitted] = useState(false);
  
  // ESTADO CUENTA REGRESIVA
  const [timeLeft, setTimeLeft] = useState({});

  // AUDIO
  const [isMuted, setIsMuted] = useState(false);
  const audioRef = useRef(null);

  // --- DATOS DEL CUMPLEA√ëOS (¬°EDITAR AQU√ç!) ---
  const partyData = {
    name: "SANTIAGO",
    age: "10",
    date: "24 de Octubre",
    // FORMATO ISO IMPORTANTE PARA LA CUENTA REGRESIVA (A√±o-Mes-D√≠aTHora:Minutos:00)
    dateISO: "2025-10-24T16:00:00", 
    time: "16:00 - 20:00",
    location: "Pizza Planet, Calle Falsa 123",
    mapLink: "https://maps.google.com",
    giftInfo: {
      message: "El mejor regalo es tu presencia, pero si quieres obsequiarme algo:",
      bank: "BBVA: 1234 5678 9012 3456",
      amazon: "https://amazon.com.mx/wishlist",
      envelope: "Lluvia de Sobres (Efectivo)"
    }
  };
  // ---------------------------------------------

  // L√≥gica Cuenta Regresiva
  useEffect(() => {
    const calculateTimeLeft = () => {
      const difference = +new Date(partyData.dateISO) - +new Date();
      let timeLeft = {};

      if (difference > 0) {
        timeLeft = {
          D√çAS: Math.floor(difference / (1000 * 60 * 60 * 24)),
          HRS: Math.floor((difference / (1000 * 60 * 60)) % 24),
          MIN: Math.floor((difference / 1000 / 60) % 60),
          SEG: Math.floor((difference / 1000) % 60),
        };
      }
      return timeLeft;
    };

    setTimeLeft(calculateTimeLeft());
    const timer = setInterval(() => {
      setTimeLeft(calculateTimeLeft());
    }, 1000);

    return () => clearInterval(timer);
  }, [partyData.dateISO]);

  // SFX: Sonido de golpe
  const playHitSound = () => {
    if (isMuted) return;
    try {
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      if (!AudioContext) return;
      const ctx = new AudioContext();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'square';
      osc.frequency.setValueAtTime(150, ctx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(40, ctx.currentTime + 0.1);
      gain.gain.setValueAtTime(0.1, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start();
      osc.stop(ctx.currentTime + 0.1);
    } catch (e) {
      console.error("Audio API error", e);
    }
  };

  const handleStartGame = () => {
    setHasStarted(true);
    if (audioRef.current) {
      audioRef.current.volume = 0.5;
      audioRef.current.play().catch(error => console.warn("Audio block:", error));
    }
  };

  const toggleMute = (e) => {
    e.stopPropagation();
    if (audioRef.current) {
      const newMutedState = !isMuted;
      audioRef.current.muted = newMutedState;
      setIsMuted(newMutedState);
      if (newMutedState === false) {
        audioRef.current.play().catch(e => console.log("Reintento fail", e));
      }
    }
  };

  const handleMineBlock = (e) => {
    if (blockHealth <= 0) return;
    playHitSound();
    if (navigator.vibrate) navigator.vibrate(50);
    const rect = e.target.getBoundingClientRect();
    spawnParticles(e.clientX - rect.left, e.clientY - rect.top);
    const newHealth = blockHealth - 1;
    setBlockHealth(newHealth);
    if (newHealth <= 0) {
      setTimeout(() => setGameState('open'), 500);
    } else {
      setGameState('mining');
      setTimeout(() => setGameState('start'), 100);
    }
  };

  const spawnParticles = (x, y) => {
    const newParticles = [];
    for (let i = 0; i < 5; i++) {
      newParticles.push({
        id: Date.now() + i,
        x: x + (Math.random() - 0.5) * 40,
        y: y + (Math.random() - 0.5) * 40,
        vx: (Math.random() - 0.5) * 10,
        vy: (Math.random() - 0.5) * 10 - 5,
      });
    }
    setParticles(prev => [...prev, ...newParticles]);
    setTimeout(() => setParticles(prev => prev.slice(5)), 1000);
  };

  const handleRSVPSubmit = (e) => {
    e.preventDefault();
    setIsSubmitted(true);

    // --- ENVIAR A WHATSAPP ---
    const phoneNumber = "521234567890"; // Tu n√∫mero
    const message = `¬°Hola! Soy ${rsvpName} y acepto la misi√≥n. Confirmo mi asistencia al cumplea√±os de ${partyData.name}.`;
    const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
    
    // Abrir WhatsApp en una nueva pesta√±a
    window.open(whatsappUrl, '_blank');

    setTimeout(() => {
      setShowRSVP(false);
      setIsSubmitted(false);
      setRsvpName('');
    }, 2000);
  };

  return (
    <div className="min-h-screen bg-gray-900 font-pixel text-white overflow-hidden relative selection:bg-green-500 selection:text-black">
      
      {/* -----------------------------------------------------
          üéµ CAMBIAR M√öSICA AQU√ç ABAJO
          Pega tu enlace .mp3 dentro de las comillas de src="..."
          -----------------------------------------------------
      */}
      <audio ref={audioRef} loop preload="auto">
        <source src="https://github.com/fiesteala/minecraft/raw/refs/heads/main/Minecraft.mp3" type="audio/mpeg" />
      </audio>

      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        .font-pixel { font-family: 'VT323', monospace; }
        .minecraft-btn {
          box-shadow: inset -4px -4px 0px 0px rgba(0,0,0,0.5), inset 4px 4px 0px 0px rgba(255,255,255,0.5);
          image-rendering: pixelated;
        }
        .minecraft-btn:active {
          box-shadow: inset 4px 4px 0px 0px rgba(0,0,0,0.5), inset -4px -4px 0px 0px rgba(255,255,255,0.5);
          transform: translateY(2px);
        }
        .minecraft-panel {
          background-color: #C6C6C6;
          border: 4px solid #000;
          box-shadow: inset -4px -4px 0px 0px #555, inset 4px 4px 0px 0px #FFF;
          color: #202020;
        }
        .dirt-texture {
          background-color: #5d4037;
          background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%233e2723' fill-opacity='0.4' fill-rule='evenodd'%3E%3Cpath d='M0 0h40v40H0V0zm20 20h20v20H20V20zM0 20h20v20H0V20zM20 0h20v20H20V0z'/%3E%3C/g%3E%3C/svg%3E");
        }
        .grass-top { background-color: #388e3c; border-bottom: 4px solid #1b5e20; }
        .crack-1 { clip-path: polygon(20% 0%, 80% 0%, 100% 20%, 100% 80%, 80% 100%, 20% 100%, 0% 80%, 0% 20%); background: rgba(0,0,0,0.1); }
        .crack-2 { clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%); background: rgba(0,0,0,0.2); }
        .crack-3 { clip-path: polygon(40% 0%, 60% 0%, 100% 40%, 100% 60%, 60% 100%, 40% 100%, 0% 60%, 0% 40%); background: rgba(0,0,0,0.3); }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        @keyframes pulse-glow { 0% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(52, 211, 153, 0); } 100% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0); } }
        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-pulse-glow { animation: pulse-glow 2s infinite; }
      `}</style>

      {/* FONDO */}
      <div className="absolute inset-0 bg-blue-400 z-0">
        <div className="absolute bottom-0 w-full h-1/3 bg-green-600 border-t-8 border-green-800"></div>
        <div className="absolute top-10 left-10 w-24 h-8 bg-white opacity-80 animate-pulse"></div>
        <div className="absolute top-20 right-20 w-32 h-10 bg-white opacity-60"></div>
      </div>

      {!hasStarted && (
        <div className="absolute inset-0 z-50 flex flex-col items-center justify-center bg-black/60 backdrop-blur-sm p-4">
          <h1 className="text-5xl text-center mb-8 text-white drop-shadow-[4px_4px_0_#000]">
            MINECRAFT<br/>PARTY
          </h1>
          <button 
            onClick={handleStartGame}
            className="minecraft-btn bg-green-600 text-white text-3xl px-8 py-4 border-2 border-white animate-pulse-glow hover:bg-green-500 active:translate-y-1"
          >
            ENTRAR AL MUNDO
          </button>
        </div>
      )}

      {hasStarted && (
        <>
          <button onClick={toggleMute} className="absolute top-4 right-4 z-40 p-2 bg-black/50 hover:bg-black/70 rounded border-2 border-white/50 text-white transition-colors">
            {isMuted ? <VolumeX size={24} /> : <Volume2 size={24} />}
          </button>

          {gameState !== 'open' ? (
            <div className="relative z-10 flex flex-col items-center justify-center h-screen p-4">
              <h1 className="text-4xl md:text-6xl text-center mb-8 text-white drop-shadow-[4px_4px_0_rgba(0,0,0,0.8)] animate-float">
                CUMPLEA√ëOS DE<br/>
                <span className="text-yellow-400">{partyData.name}</span>
              </h1>
              <div className="relative cursor-pointer select-none" onClick={handleMineBlock}>
                <div className={`w-40 h-40 relative transform transition-transform duration-100 ${gameState === 'mining' ? 'scale-95' : 'scale-100'}`}>
                  <div className="w-full h-full dirt-texture border-4 border-black box-border relative">
                    <div className="absolute top-0 left-0 w-full h-1/3 grass-top"></div>
                    {blockHealth < 5 && blockHealth > 3 && <div className="absolute inset-0 crack-1"></div>}
                    {blockHealth <= 3 && blockHealth > 1 && <div className="absolute inset-0 crack-2"></div>}
                    {blockHealth <= 1 && <div className="absolute inset-0 crack-3"></div>}
                  </div>
                </div>
                {particles.map(p => (
                  <div key={p.id} className="absolute w-2 h-2 bg-yellow-900 pointer-events-none" style={{ left: 0, top: 0, transform: `translate(${p.x}px, ${p.y}px)` }} />
                ))}
              </div>
              <p className="mt-8 text-2xl text-center bg-black/50 p-2 rounded text-white animate-pulse">
                {blockHealth > 0 ? "¬°TOCA EL BLOQUE!" : "¬°ABRIENDO!"}
              </p>
              <div className="mt-4 w-64 h-6 bg-gray-800 border-2 border-white rounded-full overflow-hidden">
                 <div className="h-full bg-green-500 transition-all duration-200" style={{ width: `${(1 - blockHealth/5) * 100}%` }}></div>
              </div>
            </div>
          ) : (
            <div className="relative z-10 h-screen flex flex-col items-center justify-center p-4 animate-fadeIn overflow-y-auto">
              <div className="minecraft-panel p-6 w-full max-w-md relative animate-float mt-10 mb-10">
                <div className="absolute -top-12 left-1/2 transform -translate-x-1/2">
                    <div className="w-24 h-24 bg-green-500 border-4 border-black flex items-center justify-center relative shadow-lg">
                        <div className="w-12 h-12 relative">
                            <div className="absolute top-2 left-2 w-3 h-3 bg-black"></div>
                            <div className="absolute top-2 right-2 w-3 h-3 bg-black"></div>
                            <div className="absolute top-5 left-5 w-2 h-4 bg-black"></div>
                            <div className="absolute bottom-1 left-3 w-2 h-3 bg-black"></div>
                            <div className="absolute bottom-1 right-3 w-2 h-3 bg-black"></div>
                            <div className="absolute bottom-3 left-4 w-4 h-2 bg-black"></div>
                        </div>
                    </div>
                </div>

                <div className="mt-10 text-center">
                  <h2 className="text-3xl font-bold mb-2 leading-none">¬°INVITACI√ìN!</h2>
                  <div className="h-1 w-full bg-gray-600 mb-4"></div>
                  
                  <p className="text-xl mb-4">
                    Celebra el <span className="text-purple-700 font-bold">NIVEL {partyData.age}</span> de {partyData.name}
                  </p>

                  {/* CUENTA REGRESIVA */}
                  <div className="bg-black/20 p-2 mb-4 rounded border-2 border-gray-500">
                    <p className="text-sm text-gray-700 font-bold mb-1">COMIENZA EN:</p>
                    <div className="flex justify-center gap-2 text-xl font-bold text-gray-800">
                      {Object.keys(timeLeft).length > 0 ? Object.entries(timeLeft).map(([unit, value]) => (
                        <div key={unit} className="flex flex-col items-center w-12">
                          <span className="bg-gray-700 text-white w-full rounded">{value < 10 ? `0${value}` : value}</span>
                          <span className="text-xs mt-1">{unit}</span>
                        </div>
                      )) : <span>¬°ES HOY!</span>}
                    </div>
                  </div>

                  <div className="space-y-3 text-left bg-gray-300 p-3 border-2 border-gray-500 mb-4 text-lg">
                    <div className="flex items-center gap-2">
                      <Calendar className="w-5 h-5 text-blue-600 flex-shrink-0" />
                      <span>{partyData.date}</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <Clock className="w-5 h-5 text-blue-600 flex-shrink-0" />
                      <span>{partyData.time}</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <MapPin className="w-5 h-5 text-red-600 flex-shrink-0" />
                      <span className="leading-none">{partyData.location}</span>
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-2">
                    <button onClick={() => setShowRSVP(true)} className="minecraft-btn col-span-2 py-3 bg-green-600 text-white text-xl font-bold hover:bg-green-500 active:translate-y-1 border-2 border-black">
                      ACEPTAR MISI√ìN
                    </button>
                    
                    <a href={partyData.mapLink} target="_blank" rel="noreferrer" className="minecraft-btn flex items-center justify-center py-2 bg-blue-600 text-white text-lg font-bold hover:bg-blue-500 active:translate-y-1 border-2 border-black">
                      <MapPin size={18} className="mr-2"/> MAPA
                    </a>

                    <button onClick={() => setShowGifts(true)} className="minecraft-btn flex items-center justify-center py-2 bg-purple-600 text-white text-lg font-bold hover:bg-purple-500 active:translate-y-1 border-2 border-black">
                      <Gift size={18} className="mr-2"/> REGALOS
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* MODAL RSVP */}
          {showRSVP && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
              <div className="minecraft-panel w-full max-w-sm p-4 relative animate-shake">
                <button onClick={() => setShowRSVP(false)} className="absolute top-2 right-2 text-gray-700 hover:text-red-600"><X size={24} /></button>
                <h3 className="text-2xl font-bold mb-4 text-center">CONFIRMAR</h3>
                {!isSubmitted ? (
                  <form onSubmit={handleRSVPSubmit} className="flex flex-col gap-4">
                    <div>
                      <label className="block text-lg mb-1">Tu Nombre:</label>
                      <input type="text" required value={rsvpName} onChange={(e) => setRsvpName(e.target.value)} className="w-full p-2 bg-gray-200 border-2 border-gray-600 font-pixel text-xl focus:outline-none" placeholder="Steve..." />
                    </div>
                    <button type="submit" className="minecraft-btn w-full py-2 bg-green-600 text-white text-xl hover:bg-green-500">ENVIAR</button>
                  </form>
                ) : (
                  <div className="text-center py-8"><p className="text-green-700 text-2xl">¬°CONFIRMADO!</p></div>
                )}
              </div>
            </div>
          )}

          {/* MODAL MESA DE REGALOS */}
          {showGifts && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
              <div className="minecraft-panel w-full max-w-sm p-6 relative">
                <button onClick={() => setShowGifts(false)} className="absolute top-2 right-2 text-gray-700 hover:text-red-600"><X size={24} /></button>
                
                <div className="flex justify-center mb-4">
                  <Gift size={48} className="text-purple-700" />
                </div>
                
                <h3 className="text-2xl font-bold mb-2 text-center">MESA DE REGALOS</h3>
                <p className="text-center mb-6 text-sm">{partyData.giftInfo.message}</p>
                
                <div className="space-y-4">
                  <div className="bg-white/50 p-3 border-2 border-gray-600 rounded">
                    <p className="font-bold text-sm text-gray-800">‚úâÔ∏è SOBRE:</p>
                    <p className="text-lg">{partyData.giftInfo.envelope}</p>
                  </div>

                  {/* Opcional: Descomentar si usas cuenta bancaria
                  <div className="bg-white/50 p-3 border-2 border-gray-600 rounded">
                    <p className="font-bold text-sm text-gray-800">üè¶ BANCO:</p>
                    <p className="text-sm break-all">{partyData.giftInfo.bank}</p>
                  </div>
                  */}
                  
                  {/* Opcional: Descomentar si usas Amazon
                  <a href={partyData.giftInfo.amazon} target="_blank" rel="noreferrer" className="block text-center minecraft-btn py-2 bg-yellow-500 text-white border-2 border-black hover:bg-yellow-400">
                    VER LISTA AMAZON
                  </a> 
                  */}
                </div>
              </div>
            </div>
          )}
        </>
      )}
    </div>
  );
}